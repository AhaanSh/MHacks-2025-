<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 40px; background-color: #f0f4f8; }
        .container { max-width: 900px; margin: auto; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        h1 { color: #007bff; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .extraction-block { border: 1px solid #e0e0e0; padding: 20px; margin-bottom: 20px; border-radius: 8px; background-color: #f7f7f7; }
        form { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        input[type="file"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
        .basic-btn { background-color: #007bff; }
        .listing-btn { background-color: #28a745; }
        .agent-btn { background-color: #ff9900; color: #333; }
        h3 { margin-top: 0; }
        
        /* Progress Bar Styles */
        #progressBarContainer {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
            height: 25px; 
            display: none;
        }
        #progressBar {
            height: 100%;
            width: 0%;
            background-color: #007bff;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
            transition: width 0.3s ease; 
        }

        .result-box { margin-top: 10px; padding: 15px; border: 1px solid #ccc; background: #fafafa; white-space: pre-wrap; font-family: monospace; border-radius: 4px; overflow-x: auto; max-height: 400px; }
        .status-message { font-style: italic; color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ title }}</h1>
        <p>This API uses three separate processes to ensure reliable extraction of 15 key property fields. Upload the same file below for any process.</p>
        
        <div class="extraction-block">
            <h3>1. Basic Property Details (8 Fields)</h3>
            <p>Includes: Address, Location (City/State), Type, Sq. Footage, Bedrooms, Bathrooms, Status, and Listing Type.</p>
            <form data-endpoint="{{ endpoints.basic }}" data-process-name="Basic Details" class="extraction-form">
                <input type="file" name="file" accept=".csv, .xlsx, .xls" required>
                <button type="submit" class="basic-btn">Extract Basic Details</button>
            </form>
        </div>

        <div class="extraction-block">
            <h3>2. Listing Details (4 Fields)</h3>
            <p>Includes: Price, Days on Market, HOA Fee, and Agent Phone.</p>
            <form data-endpoint="{{ endpoints.listing }}" data-process-name="Listing Details" class="extraction-form">
                <input type="file" name="file" accept=".csv, .xlsx, .xls" required>
                <button type="submit" class="listing-btn">Extract Listing Details</button>
            </form>
        </div>

        <div class="extraction-block">
            <h3>3. Agent & Office Details (3 Fields)</h3>
            <p>Includes: Agent Name, Agent Email, and Consolidated Office Contact Information.</p>
            <form data-endpoint="{{ endpoints.agent }}" data-process-name="Agent Details" class="extraction-form">
                <input type="file" name="file" accept=".csv, .xlsx, .xls" required>
                <button type="submit" class="agent-btn">Extract Agent Details</button>
            </form>
        </div>

        <h2>Last Extraction Results:</h2>
        
        <div id="progressBarContainer">
            <div id="progressBar">0%</div>
        </div>
        
        <div id="statusMessage" class="status-message">Ready for extraction.</div>
        <pre class="result-box" id="results">{}</pre>

    </div>

    <script>
        const CHUNK_SIMULATION_TIME_MS = 2500; 

        document.querySelectorAll('.extraction-form').forEach(form => {
            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                const fileInput = form.querySelector('input[type="file"]');
                const resultsBox = document.getElementById('results');
                const statusMessage = document.getElementById('statusMessage');
                const progressBarContainer = document.getElementById('progressBarContainer');
                const progressBar = document.getElementById('progressBar');
                const endpoint = form.getAttribute('data-endpoint');
                const processName = form.getAttribute('data-process-name');

                if (fileInput.files.length === 0) {
                    statusMessage.textContent = "Please select a file.";
                    return;
                }

                // --- 1. Start Progress Bar ---
                progressBarContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressBar.style.backgroundColor = '#007bff';

                statusMessage.textContent = `${processName}: Starting data analysis...`;
                resultsBox.textContent = "{}"; 

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                
                // Progress simulation setup
                const totalSimulatedSteps = 10;
                let currentStep = 0;
                
                const intervalId = setInterval(() => {
                    if (currentStep < totalSimulatedSteps) {
                        currentStep++;
                        const percent = Math.min(99, Math.round((currentStep / totalSimulatedSteps) * 100));
                        progressBar.style.width = percent + '%';
                        progressBar.textContent = percent + '% (Processing)';
                        statusMessage.textContent = `${processName}: Chunk processing in progress...`;
                    }
                    if (currentStep >= totalSimulatedSteps) {
                        clearInterval(intervalId);
                    }
                }, CHUNK_SIMULATION_TIME_MS);
                
                // --- 2. Fetch API Call ---
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        body: formData 
                    });
                    
                    clearInterval(intervalId);

                    const data = await response.json();

                    if (response.ok) {
                        // Success: Final update to 100%
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100% - Done!';
                        
                        statusMessage.textContent = `Extraction Complete for ${processName}. Found ${data.extracted_properties.length} records.`;
                        resultsBox.textContent = JSON.stringify(data, null, 2);
                    } else {
                        // Error: Set progress bar to red
                        progressBar.style.width = '100%';
                        progressBar.style.backgroundColor = '#dc3545'; 
                        progressBar.textContent = 'ERROR';
                        
                        statusMessage.textContent = `ERROR (${response.status}): Could not process data. Check console for details.`;
                        resultsBox.textContent = JSON.stringify(data, null, 2);
                    }

                } catch (error) {
                    clearInterval(intervalId);
                    progressBar.style.width = '100%';
                    progressBar.style.backgroundColor = '#dc3545'; 
                    progressBar.textContent = 'Network Error';
                    
                    statusMessage.textContent = "Network Error. Ensure the server is running and the API key is valid.";
                    resultsBox.textContent = `Detailed Error: ${error}`;
                }
                
                // Reset progress tracking after a brief delay
                setTimeout(() => {
                    progressBarContainer.style.display = 'none';
                }, 5000);
            });
        });
    </script>
</body>
</html>